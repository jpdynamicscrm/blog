---
title: Power Automate で接続が「無効な接続」になる原因
date: 2021-07-21 9:30:00
tags:
  - Power Automate
  - Connection
---

こんにちは、日本マイクロソフト Power Automate サポートの清水です。

今回は、Power Automate で Azure AD 認証の「接続」が無効になってしまうケースとその仕組みについてご説明いたします。

<!-- more -->

## はじめに

Power Automate を業務で使用するうえで、気になるのが「接続」の有効期限です。

Power Automate の「接続」は、ユーザーの資格情報を使用して Azure AD からトークンを取得しています。
そのため、資格情報に変更があった場合に接続が無効となる場合があることは、ご存じの方も多いかと存じますが、

「実際にパスワードを変更しても接続が切れない」
「認証情報は変更していないのに、突然接続が無効になってしまった」

といったお問い合わせをいただくことが多々ございます。

この記事では、接続が無効になるケース、ならないケースと、接続が無効になるまでの仕組みについて、詳細にご説明いたします。


## Power Automate で「無効な接続」と表示される原因

実際に接続が無効になるケース、ならないケースは以下の通りです。

| 接続が無効になるケース | 接続が無効にならないケース |
|-- |-- |
|<li>ユーザーまたは管理者による更新 トークンの無効化</li><li>管理者による Microsoft 365 管理センターでのパスワードのリセット</li><li>条件付きアクセス ポリシーや多要素認証の設定変更</li><li>デバイス登録の解除など特定の認証情報の変更</li><li>[マイ アカウント](https://myaccount.microsoft.com/) ページでの [すべてサインアウトしてください] の実行</li><li>接続が長期間 (90 日以上) 使用されていない</li><li>接続先サービス側の一時的な不具合</li>|<li>パスワードの有効期限切れ</li><li>ユーザーによるパスワード変更</li><li>ユーザーによる セルフサービス パスワード リセット</li><li>Web 上でのシングルサインアウト</li> |


## Power Automate での認証の仕組み

さて、具体的な Power Automate での認証の仕組みについて、ご説明します。

Power Automate で使用するコネクタは、Azure AD での認証を行うことで、下記 2 種類のトークンを取得しています。

- リソースに対するトークン (アクセス トークン)
- 継続的なアクセスを行うためのトークン (更新 トークン)

トークンの取得後、コネクタは上記のうちアクセス トークンを利用してリソースにアクセスします。
なお、[アクセス トークンは取り消すことはできず、有効期限が切れるまでの間は使用可能](https://learn.microsoft.com/ja-jp/azure/active-directory/develop/configurable-token-lifetimes#access-tokens)です。

アクセス トークンの有効期限なそれほど長くないため、有効期限が切れた場合には、
更新 トークンを利用してアクセス トークンを更新することで、継続的にリソースに対してアクセス可能な仕組みとなっています。

また、更新 トークンには、認証を行った際の IP アドレスや条件付きアクセス ポリシーの情報など、
内部的にユーザーがどのような認証を行ったかの情報が含まれています。

したがって、更新 トークンを使用してアクセストークンを更新する際、
条件付きアクセス ポリシーや多要素認証などの設定が認証時と異なっていると、アクセス トークンの更新は失敗し、
接続が「無効な接続」となってしまいます。

また、資格情報の変更や管理者の操作により、更新 トークン自体が無効となる場合もございます。
原因として表に挙げた例の中では、以下が当てはまります。

- ユーザーまたは管理者が PowerShell を使用して更新トークンを無効化
   Power Automate の接続は、「機密クライアントのトークン」として認識されます。
   そのため、[公開情報の表](https://learn.microsoft.com/ja-jp/azure/active-directory/develop/access-tokens#revocation)に記載の通り、更新トークンを無効化した場合のみトークンが取り消されます。
   パスワード変更や期限切れでは、更新 トークンは無効となりません。

- 接続が長期間 (90 日以上) 使用されていない
  [更新 トークンの最大非アクティブ時間](https://learn.microsoft.com/ja-jp/azure/active-directory/develop/configurable-token-lifetimes#refresh-and-session-token-lifetime-policy-properties)の制限により、接続が 90 日以上使用されていない場合、更新 トークンは失効いたします。

上記の場合、更新 トークンが失効してアクセス トークンの更新ができないため、「無効な接続」となってしまいます。

ご説明した動作をまとめると、Power Automate では、

1. アクセス トークンの有効期限が切れ、
2. 更新 トークンが失効した

場合に、リソースにアクセスするためのアクセス トークンの更新ができず、「無効な接続」が発生します。

### (補足) 時間が経ってから接続が無効になる

上述の仕組みからお分かりの通り、接続が無効になるまでには、

1. アクセス トークンの有効期限切れ
2. 更新 トークンの失効

の 2 つのステップがあります。

そのため、実際に接続が切れるような操作を行ってから接続が無効となるまで、
アクセス トークンの有効期限に応じて、期間が空く場合があることにご留意ください。

## おわりに

以上、Power Automate での認証の仕組みについてご説明しました。
認証が切れるケースに該当するような操作を行う場合は、Power Automate での接続の再認証もお忘れないよう、ご留意ください。

---
